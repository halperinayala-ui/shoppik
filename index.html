<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#8b5cf6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="×¨×©×™××ª ×§× ×™×•×ª">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ›’</text></svg>">
    <link rel="manifest" href="manifest.json">
    <title>×¨×©×™××ª ×§× ×™×•×ª ××©×¤×—×ª ×¤×™×§××¨×¡×§×™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes bounce {
            0%, 100% { transform: translateY(0) translateX(-50%); }
            50% { transform: translateY(-10px) translateX(-50%); }
        }
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        .dragging {
            opacity: 0.5;
        }
        .drag-over {
            border-top: 3px solid #8b5cf6 !important;
        }
        .note-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 10px;
            height: 10px;
            background: #ef4444;
            border-radius: 50%;
            border: 2px solid white;
        }
        [draggable="true"] {
            cursor: move;
        }
        [draggable="true"]:active {
            cursor: grabbing;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 via-purple-50 to-blue-50 min-h-screen">
    <div id="root"></div>
    <div id="noteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="if(event.target === event.currentTarget) window.closeNoteModal()">
        <div class="bg-white rounded-xl p-5 max-w-md w-full" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold mb-3 text-gray-800">×”×¢×¨×”</h3>
            <textarea id="noteText" class="w-full border-2 border-gray-300 rounded-lg p-3 text-sm mb-3 min-h-[100px] focus:border-purple-400 focus:outline-none" placeholder="×›×ª×•×‘ ×”×¢×¨×” ×›××Ÿ..."></textarea>
            <div class="flex gap-2 justify-end">
                <button onclick="window.closeNoteModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg text-sm font-semibold">×‘×™×˜×•×œ</button>
                <button onclick="window.saveNote()" class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-sm font-semibold">×©××•×¨</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, onSnapshot, setDoc, doc, deleteDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyC0p8tT-zRT1wCkyIfD7y_8dVaEcEdW_4",
            authDomain: "shpping-list-piekarski.firebaseapp.com",
            projectId: "shpping-list-piekarski",
            storageBucket: "shpping-list-piekarski.firebasestorage.app",
            messagingSenderId: "454849614518",
            appId: "1:454849614518:web:cccd2845f38bae7e0acc17"
        };

        const CATEGORIES = [
            { id: 'dry', name: '××•×¦×¨×™× ×™×‘×©×™×', icon: 'ğŸŒ¾', color: 'orange' },
            { id: 'basics', name: '××•×¦×¨×™ ×™×¡×•×“', icon: 'ğŸ§‚', color: 'blue' },
            { id: 'canned', name: '×©×™××•×¨×™×', icon: 'ğŸ¥«', color: 'purple' },
            { id: 'cleaning', name: '××•×¦×¨×™ × ×§×™×•×Ÿ ×•×—×“ ×¤×¢××™', icon: 'ğŸ§¹', color: 'orange' },
            { id: 'dairy', name: '×‘×™×¦×™× ×•××§×¨×¨', icon: 'ğŸ¥š', color: 'blue' },
            { id: 'vegetables', name: '×™×¨×§×•×ª', icon: 'ğŸ¥¬', color: 'purple' },
            { id: 'bakery', name: '×××¤×™×', icon: 'ğŸ¥–', color: 'orange' },
            { id: 'frozen', name: '×§×¤×•××™×', icon: 'â„ï¸', color: 'blue' },
            { id: 'drinks', name: '×©×ª×™×”', icon: 'ğŸ¥¤', color: 'purple' },
            { id: 'other', name: '×©×•× ×•×ª', icon: 'ğŸ“¦', color: 'orange' }
        ];

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let items = [];
        let newItem = '';
        let newQuantity = '';
        let selectedCategory = 'dry';
        let collapsedCategories = {};
        let notification = null;
        let prevItemsCount = 0;
        let draggedItemId = null;
        let currentNoteItemId = null;

        const icons = {
            plus: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>',
            x: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',
            check: '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>',
            chevronDown: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>',
            chevronUp: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>',
            bell: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>',
            grip: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h4m0 0V4m0 4l-4 4m16-4h-4m0 0V4m0 4l4 4M4 16h4m0 0v4m0-4l-4-4m16 4h-4m0 0v4m0-4l4-4"></path></svg>',
            note: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path></svg>'
        };

        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                alert('×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘×”×ª×¨××•×ª');
                return;
            }

            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    showNotification('×”×ª×¨××•×ª ×”×•×¤×¢×œ×• ×‘×”×¦×œ×—×”! ğŸ‰');
                } else {
                    alert('×”×ª×¨××•×ª × ×“×—×•. ×ª×•×›×œ ×œ×”×¤×¢×™×œ ××•×ª×Ÿ ××”×”×’×“×¨×•×ª ×©×œ ×”×“×¤×“×¤×Ÿ.');
                }
                render();
            } catch (error) {
                console.error('Error requesting permission:', error);
            }
        }

        function getCategoryColors(color, checked) {
            if (checked) return 'bg-green-50 border-green-300';
            const colors = {
                orange: 'bg-orange-50 border-orange-200 hover:border-orange-300',
                blue: 'bg-blue-50 border-blue-200 hover:border-blue-300',
                purple: 'bg-purple-50 border-purple-200 hover:border-purple-300'
            };
            return colors[color];
        }

        function getCategoryHeaderColor(color) {
            const colors = {
                orange: 'bg-gradient-to-r from-orange-500 to-orange-600',
                blue: 'bg-gradient-to-r from-blue-500 to-blue-600',
                purple: 'bg-gradient-to-r from-purple-500 to-purple-600'
            };
            return colors[color];
        }

        function showNotification(message) {
            notification = message;
            render();
            
            if (Notification.permission === 'granted') {
                new Notification('×¨×©×™××ª ×§× ×™×•×ª ××©×¤×—×ª ×¤×™×§××¨×¡×§×™', {
                    body: message,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ğŸ›’</text></svg>',
                    tag: 'shopping-list',
                    requireInteraction: false
                });
            }
            
            setTimeout(() => {
                notification = null;
                render();
            }, 3000);
        }

        async function addItem() {
            const input = document.getElementById('newItemInput');
            const quantityInput = document.getElementById('quantityInput');
            const text = input ? input.value.trim() : newItem.trim();
            const quantity = quantityInput ? quantityInput.value.trim() : newQuantity.trim();
            
            if (!text) return;
            
            try {
                const itemId = Date.now().toString();
                const categoryItems = items.filter(i => i.category === selectedCategory);
                const maxOrder = categoryItems.length > 0 
                    ? Math.max(...categoryItems.map(i => i.order || 0))
                    : 0;
                
                await setDoc(doc(db, 'shoppingItems', itemId), {
                    text: text,
                    quantity: quantity,
                    category: selectedCategory,
                    checked: false,
                    timestamp: Date.now(),
                    order: maxOrder + 1,
                    note: ''
                });
                
                newItem = '';
                newQuantity = '';
                if (input) input.value = '';
                if (quantityInput) quantityInput.value = '';
                render();
            } catch (error) {
                console.error('Error adding item:', error);
            }
        }

        async function toggleItem(id) {
            try {
                const item = items.find(i => i.id === id);
                await updateDoc(doc(db, 'shoppingItems', id), {
                    checked: !item.checked
                });
            } catch (error) {
                console.error('Error toggling item:', error);
            }
        }

        async function deleteItem(id) {
            try {
                await deleteDoc(doc(db, 'shoppingItems', id));
            } catch (error) {
                console.error('Error deleting item:', error);
            }
        }

        async function clearChecked() {
            const checkedItems = items.filter(item => item.checked);
            for (const item of checkedItems) {
                await deleteItem(item.id);
            }
        }

        async function clearAll() {
            if (confirm('×œ××—×•×§ ××ª ×›×œ ×”×¨×©×™××”?')) {
                for (const item of items) {
                    await deleteItem(item.id);
                }
            }
        }

        function toggleCategory(categoryId) {
            collapsedCategories[categoryId] = !collapsedCategories[categoryId];
            render();
        }

        function getItemsByCategory(categoryId) {
            return items
                .filter(item => item.category === categoryId)
                .sort((a, b) => (a.order || 0) - (b.order || 0));
        }

        function openNoteModal(itemId) {
            currentNoteItemId = itemId;
            const item = items.find(i => i.id === itemId);
            document.getElementById('noteText').value = item.note || '';
            document.getElementById('noteModal').classList.remove('hidden');
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.add('hidden');
            currentNoteItemId = null;
        }

        async function saveNote() {
            if (!currentNoteItemId) return;
            const noteText = document.getElementById('noteText').value;
            try {
                await updateDoc(doc(db, 'shoppingItems', currentNoteItemId), {
                    note: noteText
                });
                closeNoteModal();
            } catch (error) {
                console.error('Error saving note:', error);
            }
        }

        function handleDragStart(e, itemId) {
            draggedItemId = itemId;
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
            draggedItemId = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        async function handleDrop(e, targetItemId) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            if (!draggedItemId || draggedItemId === targetItemId) return;
            
            const draggedItem = items.find(i => i.id === draggedItemId);
            const targetItem = items.find(i => i.id === targetItemId);
            
            if (draggedItem.category !== targetItem.category) return;
            
            const categoryItems = getItemsByCategory(draggedItem.category);
            const draggedIndex = categoryItems.findIndex(i => i.id === draggedItemId);
            const targetIndex = categoryItems.findIndex(i => i.id === targetItemId);
            
            const reordered = [...categoryItems];
            const [removed] = reordered.splice(draggedIndex, 1);
            reordered.splice(targetIndex, 0, removed);
            
            for (let i = 0; i < reordered.length; i++) {
                await updateDoc(doc(db, 'shoppingItems', reordered[i].id), {
                    order: i
                });
            }
        }

        function render() {
            const checkedCount = items.filter(item => item.checked).length;
            const totalCount = items.length;
            const notificationStatus = Notification.permission === 'granted' ? 'ğŸ””' : 'ğŸ”•';

            const html = `
                <div class="p-4 pb-8">
                    <div class="max-w-3xl mx-auto">
                        
                        ${notification ? `
                        <div class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 animate-bounce">
                            <div class="bg-gradient-to-r from-purple-500 to-blue-500 text-white px-6 py-3 rounded-full shadow-lg flex items-center gap-2">
                                ${icons.bell}
                                <span class="font-medium">${notification}</span>
                            </div>
                        </div>
                        ` : ''}

                        <div class="bg-white rounded-xl shadow-lg border-2 border-purple-200 p-3 mb-3">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h1 class="text-lg font-bold bg-gradient-to-r from-orange-500 via-purple-500 to-blue-500 bg-clip-text text-transparent">
                                        ×¨×©×™××ª ×§× ×™×•×ª ××©×¤×—×ª ×¤×™×§××¨×¡×§×™
                                    </h1>
                                    <p class="text-xs text-gray-600">
                                        ${totalCount > 0 ? `
                                            <span class="font-semibold">${totalCount}</span> ×¤×¨×™×˜×™×
                                            ${checkedCount > 0 ? `<span class="mr-2">â€¢ <span class="font-semibold text-green-600">${checkedCount}</span> × ×§× ×•</span>` : ''}
                                        ` : '×”×¨×©×™××” ×¨×™×§×”'}
                                    </p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-green-600 font-medium">ğŸ”¥ Live</span>
                                    <button 
                                        onclick="window.requestNotificationPermission()"
                                        class="text-lg cursor-pointer hover:scale-110 transition-transform"
                                        title="${Notification.permission === 'granted' ? '×”×ª×¨××•×ª ××•×¤×¢×œ×•×ª' : '×œ×—×¥ ×œ×”×¤×¢×œ×ª ×”×ª×¨××•×ª'}"
                                    >
                                        ${notificationStatus}
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg border-2 border-orange-200 p-3 mb-3">
                            <div class="flex flex-col gap-2">
                                <div class="flex gap-2">
                                    <input
                                        type="text"
                                        id="newItemInput"
                                        placeholder="×©× ×”××•×¦×¨..."
                                        class="flex-1 px-3 py-2 text-sm border-2 border-gray-200 rounded-lg focus:border-purple-400 focus:outline-none focus:ring-1 focus:ring-purple-100 transition-all"
                                    />
                                    <input
                                        type="text"
                                        id="quantityInput"
                                        placeholder="×›××•×ª (××•×¤×¦×™×•× ×œ×™)"
                                        class="w-32 px-3 py-2 text-sm border-2 border-gray-200 rounded-lg focus:border-purple-400 focus:outline-none focus:ring-1 focus:ring-purple-100 transition-all"
                                    />
                                </div>
                                
                                <div class="flex gap-2">
                                    <select
                                        id="categorySelect"
                                        class="flex-1 px-3 py-2 text-sm border-2 border-gray-200 rounded-lg focus:border-blue-400 focus:outline-none focus:ring-1 focus:ring-blue-100 transition-all bg-white"
                                    >
                                        ${CATEGORIES.map(cat => `
                                            <option value="${cat.id}" ${selectedCategory === cat.id ? 'selected' : ''}>
                                                ${cat.icon} ${cat.name}
                                            </option>
                                        `).join('')}
                                    </select>
                                    
                                    <button
                                        onclick="window.addItem()"
                                        class="px-4 py-2 text-sm bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white rounded-lg font-semibold transition-all shadow-md flex items-center gap-1"
                                    >
                                        ${icons.plus}
                                        ×”×•×¡×£
                                    </button>
                                </div>
                            </div>
                        </div>

                        ${totalCount > 0 ? `
                        <div class="flex gap-2 mb-3">
                            ${checkedCount > 0 ? `
                            <button
                                onclick="window.clearChecked()"
                                class="px-3 py-1.5 text-xs bg-green-100 hover:bg-green-200 text-green-700 rounded-lg font-semibold transition-all border border-green-300 shadow-sm"
                            >
                                × ×§×” ××¡×•×× ×™× (${checkedCount})
                            </button>
                            ` : ''}
                            <button
                                onclick="window.clearAll()"
                                class="px-3 py-1.5 text-xs bg-red-100 hover:bg-red-200 text-red-700 rounded-lg font-semibold transition-all border border-red-300 shadow-sm"
                            >
                                ××¤×¡ ×”×›×œ
                            </button>
                        </div>
                        ` : ''}

                        <div class="space-y-3">
                            ${CATEGORIES.map(category => {
                                const categoryItems = getItemsByCategory(category.id);
                                if (categoryItems.length === 0) return '';

                                const checkedInCategory = categoryItems.filter(item => item.checked).length;
                                const isCollapsed = collapsedCategories[category.id];

                                return `
                                <div class="bg-white rounded-xl shadow-lg border-2 border-gray-200 overflow-hidden">
                                    <button
                                        onclick="window.toggleCategory('${category.id}')"
                                        class="w-full px-3 py-2.5 flex items-center justify-between ${getCategoryHeaderColor(category.color)} hover:opacity-90 transition-all"
                                    >
                                        <div class="flex items-center gap-2">
                                            <span class="text-lg">${category.icon}</span>
                                            <div class="text-right">
                                                <h2 class="font-bold text-white text-sm">${category.name}</h2>
                                                <p class="text-xs text-white/90">
                                                    ${categoryItems.length} ×¤×¨×™×˜×™×
                                                    ${checkedInCategory > 0 ? ` â€¢ ${checkedInCategory} × ×§× ×•` : ''}
                                                </p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            ${isCollapsed ? `<span class="text-white text-xs bg-white/20 px-2 py-0.5 rounded-full">${categoryItems.length}</span>` : ''}
                                            ${isCollapsed ? icons.chevronDown : icons.chevronUp}
                                        </div>
                                    </button>

                                    ${!isCollapsed ? `
                                    <div class="px-3 pb-2 pt-2 space-y-1.5">
                                        ${categoryItems.map(item => `
                                        <div 
                                            draggable="true"
                                            data-item-id="${item.id}"
                                            class="flex items-center gap-2 p-2.5 rounded-lg border transition-all shadow-sm ${getCategoryColors(category.color, item.checked)}"
                                        >
                                            <button
                                                onclick="event.stopPropagation(); window.toggleItem('${item.id}')"
                                                class="flex-shrink-0 w-5 h-5 rounded-md border-2 flex items-center justify-center transition-all ${
                                                    item.checked
                                                        ? 'bg-green-500 border-green-500 shadow-md'
                                                        : 'border-gray-400 hover:border-purple-500 hover:shadow-md'
                                                }"
                                            >
                                                ${item.checked ? icons.check : ''}
                                            </button>

                                            <span class="flex-1 text-sm ${item.checked ? 'line-through text-gray-500' : 'text-gray-800 font-medium'}">
                                                ${item.quantity ? `<span class="text-purple-600 font-semibold">${item.quantity}</span> ` : ''}${item.text}
                                            </span>

                                            <button
                                                onclick="event.stopPropagation(); window.openNoteModal('${item.id}')"
                                                class="relative flex-shrink-0 p-1 hover:bg-blue-100 rounded-md transition-colors text-blue-500"
                                            >
                                                ${icons.note}
                                                ${item.note ? '<span class="note-badge"></span>' : ''}
                                            </button>

                                            <button
                                                onclick="event.stopPropagation(); window.deleteItem('${item.id}')"
                                                class="flex-shrink-0 p-1 hover:bg-red-100 rounded-md transition-colors"
                                            >
                                                ${icons.x}
                                            </button>
                                        </div>
                                        `).join('')}
                                    </div>
                                    ` : ''}
                                </div>
                                `;
                            }).join('')}
                        </div>

                        ${totalCount === 0 ? `
                        <div class="bg-white rounded-xl shadow-lg border-2 border-blue-200 p-8 text-center">
                            <div class="text-4xl mb-2">ğŸ›’</div>
                            <p class="text-gray-600 text-base mb-1 font-semibold">×”×¨×©×™××” ×¨×™×§×”</p>
                            <p class="text-gray-500 text-sm">×”×•×¡×™×¤×• ××¦×¨×›×™× ×œ×¨×©×™××”</p>
                        </div>
                        ` : ''}

                        ${Notification.permission !== 'granted' && Notification.permission !== 'denied' ? `
                        <div class="mt-4 bg-yellow-50 border-2 border-yellow-200 rounded-xl p-3">
                            <p class="text-xs text-yellow-800 mb-2 font-semibold">
                                ğŸ”” ×¨×•×¦×™× ×”×ª×¨××•×ª ×’× ×›×©×”××¤×œ×™×§×¦×™×” ×¡×’×•×¨×”?
                            </p>
                            <button 
                                onclick="window.requestNotificationPermission()"
                                class="px-3 py-1.5 bg-yellow-500 hover:bg-yellow-600 text-white text-xs rounded-lg font-semibold"
                            >
                                ×”×¤×¢×œ ×”×ª×¨××•×ª
                            </button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.getElementById('root').innerHTML = html;

            const input = document.getElementById('newItemInput');
            const quantityInput = document.getElementById('quantityInput');
            const select = document.getElementById('categorySelect');
            
            if (input) {
                input.addEventListener('input', (e) => {
                    newItem = e.target.value;
                });
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addItem();
                    }
                });
            }

            if (quantityInput) {
                quantityInput.addEventListener('input', (e) => {
                    newQuantity = e.target.value;
                });
                quantityInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addItem();
                    }
                });
            }

            if (select) {
                select.addEventListener('change', (e) => {
                    selectedCategory = e.target.value;
                });
            }

            document.querySelectorAll('[draggable="true"]').forEach(el => {
                el.addEventListener('dragstart', (e) => handleDragStart(e, el.dataset.itemId));
                el.addEventListener('dragend', handleDragEnd);
                el.addEventListener('dragover', handleDragOver);
                el.addEventListener('dragleave', handleDragLeave);
                el.addEventListener('drop', (e) => handleDrop(e, el.dataset.itemId));
            });
        }

        const itemsCollection = collection(db, 'shoppingItems');
        onSnapshot(itemsCollection, (snapshot) => {
            const itemsList = [];
            snapshot.forEach((doc) => {
                itemsList.push({ id: doc.id, ...doc.data() });
            });
            
            if (prevItemsCount > 0 && itemsList.length > prevItemsCount) {
                const newItemsAdded = itemsList.length - prevItemsCount;
                showNotification(`× ×•×¡×¤×• ${newItemsAdded} ×¤×¨×™×˜×™× ×œ×¨×©×™××”!`);
            }
            
            prevItemsCount = itemsList.length;
            items = itemsList;
            render();
        });

        window.addItem = addItem;
        window.toggleItem = toggleItem;
        window.deleteItem = deleteItem;
        window.clearChecked = clearChecked;
        window.clearAll = clearAll;
        window.toggleCategory = toggleCategory;
        window.requestNotificationPermission = requestNotificationPermission;
        window.openNoteModal = openNoteModal;
        window.closeNoteModal = closeNoteModal;
        window.saveNote = saveNote;

        render();
    </script>
</body>
</html>